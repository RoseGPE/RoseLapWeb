$def with (name, manifest)

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<h3>Study "${name}"</h3><select id="track_select" class="input-group-text" onchange="updateFilterOptions(); updateStudyPlot();">
  <option value="">Overall Run</option>
</select>
<select id="filter_select" class="input-group-text" onchange="updateStudyPlot();">
</select>

<!-- Create a div where the graph will take place -->
<div id="studyplot"></div>

<style>
  #studyplot {
    cursor: crosshair;
  }
</style>

<!-- Load color palettes -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<script>
manifest = $:{manifest}

/*data = [
["0_0", 3, 4, 5],
["0_1", 4, 5, 6],
["0_2", 3, 5, 8],
["1_0", 6, 9, 0],
["1_1", 5, 4, 3],
["1_2", 4, 9, 0]
]*/

function minmax(x) {
  return [Math.min(...x), Math.max(...x)]
}

function draw_studyplot(filter, track) { // if track is undefined, do the run

$$("#studyplot").html("");

// set the dimensions and margins of the graph
var margin = {top: 25, right: 25, bottom: 25, left: 25},
  width = document.getElementsByClassName("container")[0].getBoundingClientRect().width - margin.left - margin.right,
  height = 600 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#studyplot")
.append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
.append("g")
  .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");


let keys    = Object.keys(manifest.stat)
let range_x = keys.map(function(x) {return x.split("_")[0]})
let range_y = keys.map(function(x) {return x.split("_")[1]})
let range_v = []
let range_d = []
console.log(track)
if(track){
  range_v = keys.map(function(x) {return manifest.stat[x].laps[track][filter]})
  range_d = keys.map(function(x) {
    return manifest.stat[x].laps[track];
  })
}
else{
  range_v = keys.map(function(x) {return manifest.stat[x].run[filter]})
  range_d = keys.map(function(x) {
    return manifest.stat[x].run;
  })
}
range_C = []
for (let i=0; i<range_v.length; i++) {
  range_C.push({x: range_x[i], y: range_y[i], v: range_v[i], d: range_d[i]})
}

console.log(range_x, range_y, range_v, range_d, range_C)

  // Build X scales and axis:
  var x = d3.scaleBand()
    .range([ 0, width ])
    .domain(range_x)
    .padding(0);
  svg.append("g")
    .style("font-size", 15)
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).tickSize(0))
    .select(".domain").remove()

  // Build Y scales and axis:
  var y = d3.scaleBand()
    .range([ height, 0 ])
    .domain(range_y)
    .padding(0);
  svg.append("g")
    .style("font-size", 15)
    .call(d3.axisLeft(y).tickSize(0))
    .select(".domain").remove()

  // Build color scale
  var myColor = d3.scaleSequential()
    .interpolator(d3.interpolateCool)
    .domain(minmax(range_v))

  // create a tooltip
  var tooltip = d3.select("#studyplot")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "2px")
    .style("padding", "5px")

  // Three function that change the tooltip when user hover / move / leave a cell
  var mouseover = function(d) {
    tooltip
      .style("opacity", 1)
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 1)
  }
  var mousemove = function(d) {
    tooltip
      .html(Object.entries(d.d).map(function(x) {
          const [key,value]=x;
          return key+": "+value
        }).join(", ")) //"The exact value of<br>this cell is: " + d.v)
      .style("left", d3.event.pageX+"px")
      .style("top",  d3.event.pageY+"px")
  }
  var mouseleave = function(d) {
    tooltip
      .style("opacity", 0)
    d3.select(this)
      .style("stroke", "none")
      .style("opacity", 0.8)
  }

  // add the squares
  svg.selectAll()
    .remove()
    .data(range_C, function(d) {return d.v})
    .enter()
    .append("rect")
      .attr("x", function(d) { return x(d.x) })
      .attr("y", function(d) { return y(d.y) })
      .attr("rx", 0)
      .attr("ry", 0)
      .attr("width",  x.bandwidth() )
      .attr("height", y.bandwidth() )
      .style("fill", function(d) { return myColor(d.v)} )
      .style("stroke-width", 4)
      .style("stroke", "none")
      .style("opacity", 0.8)
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseleave", mouseleave)



// Add title to graph
/*svg.append("text")
        .attr("x", 0)
        .attr("y", -50)
        .attr("text-anchor", "left")
        .style("font-size", "22px")
        .text("A d3.js heatmap");

// Add subtitle to graph
svg.append("text")
        .attr("x", 0)
        .attr("y", -20)
        .attr("text-anchor", "left")
        .style("font-size", "14px")
        .style("fill", "grey")
        .style("max-width", 400)
        .text("A short description of the take-away message of this chart.");*/
}

function updateFilterOptions() {
  $$("#filter_select").find('option').remove();
  if($$("#filter_select").val() == "") {
    Object.keys(Object.values(manifest.stat)[0].run).forEach(function(filt){
      $$("#filter_select").append($$("<option>").val(filt).text(filt));
    });
  } else {
    Object.keys(Object.values(Object.values(manifest.stat)[0].laps)[0]).forEach(function(filt){
      $$("#filter_select").append($$("<option>").val(filt).text(filt));
    });
  }
}

function updateStudyPlot() {
  draw_studyplot($$("#filter_select").val(), $$("#track_select").val());
}

$$(document).ready(function() {
  $$("#track_select").find('option').remove().end().append('<option value="">Overall</option>').val('');
  manifest.tracks.forEach(function(trk){
    $$("#track_select").append($$("<option>").val(trk.name).text(trk.name));
  });

  updateFilterOptions();

  draw_studyplot("laptimes");

})
</script>