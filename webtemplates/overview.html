$def with (vehicles, tracks, studies)

<link rel="stylesheet" type="text/css" href="/static/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="/static/custom.css" />

<script type="text/javascript" src="/static/jquery.min.js" ></script>
<script type="text/javascript" src="/static/bootstrap.min.js" ></script>
<script type="text/javascript" src="/static/js-yaml.min.js" ></script>

<script>
	function new_vehicle() {
		$$("#vehicleEditModal").modal('show')
	}

	function discard_vehicle_edit() {
		$$("#vehicleEditModal").modal('hide')
	}
	
	function save_vehicle() {
		$$.post(
        "/vehicle",
        {
        	"name": $$("#vehicleEditModal").data('active_vehicle_name'),
        	"version": $$("#vehicleEditModal").data('active_vehicle_version'),
        	"filedata": $$("#vehicleEditText").val()
        }
    ).then(function(data) {
      if (data.error) {
      	alert(data.error);
      	return;
      }

			$$("#vehicleEditModal").modal('hide')
    });
	}

	function edit_vehicle(name, version) {
		$$.get("/vehicle",
      {
      	"name": name,
       	"version": version
      }
    ).then(function(data) {
      if (data.error) {
      	alert(data.error);
      	return;
      }

			$$("#vehicleEditModal").modal('show');
			$$("#vehicleEditText").keyup(validate_json_vehicle);
			$$("#vehicleEditText").change(validate_json_vehicle);

			$$("#vehicleEditModal").data('active_vehicle_name', data.name);
			$$("#vehicleEditModal").data('active_vehicle_version', data.version);
			$$("#vehicleEditModalTitle").html(`EDITING: $${data.name} v$${data.version}`);
			$$("#vehicleEditText").val(data.filedata);

			validate_json_vehicle();
    });
	}

	function validate_json_vehicle() {
		let txt = $$("#vehicleEditText").val();
		try {
			obj = jsyaml.load(txt);
			
			$$("#vehicleErrorMsg").alert()
			$$("#vehicleErrorMsg").html(`Valid YAML (may not be fully formed, but syntax is correct)`);
			$$("#vehicleErrorMsg").removeClass('alert-danger');
			$$("#vehicleErrorMsg").addClass('alert-success');

			$$("#vehicleSaveButton").html('Save');
			$$("#vehicleSaveButton").removeClass('btn-warning');
			$$("#vehicleSaveButton").addClass('btn-primary');
		} catch (error) {
			console.log(error);
			$$("#vehicleErrorMsg").alert()
			$$("#vehicleErrorMsg").html(`ERROR: $${error.message}`);
			$$("#vehicleErrorMsg").addClass('alert-danger');
			$$("#vehicleErrorMsg").removeClass('alert-success');

			$$("#vehicleSaveButton").html('Save (with errors)');
			$$("#vehicleSaveButton").addClass('btn-warning');
			$$("#vehicleSaveButton").removeClass('btn-primary');
		}
	}
</script>

<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
	<ul class="navbar-nav">
    <li class="navbar-brand">
    	<a class=" nav-link disabled">
    		RoseLap
    	</a>
    </li>
  </ul>
  <ul class="navbar-nav ml-auto mr-1">
    <li class="nav-item">
    	<a class=" nav-link disabled">
    		User: $ctx.username
    	</a>
    </li>
    <li class="nav-item">
    	<a href="/logout" class="nav-link btn btn-danger">
    		Logout
    	</a>
    </li>
  </ul>
</nav>
<br/>

<!-- Modal -->
<div class="modal fade bd-example-modal-lg" id="vehicleEditModal" tabindex="-1" role="dialog" aria-labelledby="vehicleEditModal" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="vehicleEditModalTitle">Modal title</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <textarea id="vehicleEditText" class="textedit" onchange="validate_json_vehicle()">Placeholder Text</textarea>
      </div>
      <div class="modal-footer">
      	<div class="alert alert-danger" id="vehicleErrorMsg" role="alert">Placeholder Alert</div>
        <button type="button" class="btn btn-danger" data-dismiss="modal" onclick="discard_vehicle_edit()">Discard Changes</button>
        <button type="button" class="btn btn-primary" id="vehicleSaveButton" onclick="save_vehicle()">Save changes</button>
      </div>
    </div>
  </div>
</div>

<div class="container">

	<div class="row">
		<div class="col-sm-6">
			<!--<button id="remove" class="btn btn-light disabled">Vehicles</button>-->

			<table class="table table-striped">
				<thead>
					<tr>
						<th scope="col">Vehicle</th>
						<th scope="col">Version</th>
						<th scope="col">Last Edit</th>
						<th scope="col">Errors</th>
						<th scope="col"></th>
					</tr>
				</thead>
				$for vehicle in vehicles:
					<tr>
						<td>${vehicle.name}</td>
						<td>${vehicle.version}</td>
						<td>${vehicle.edit_date}</td>
						<td>
							$if vehicle.log:
								<button class="btn-sm btn-warning">Error Log</button>
							$else:
								OK
						</td>
						<td>
							<button class="btn btn-primary btn-sm" onclick="edit_vehicle('${vehicle.name}', '${vehicle.version}')">Edit</button>
						</td>
					</tr>
				<tr>
					<td colspan="5">
						<button id="remove" class="btn btn-secondary btn-block btn-sm" onclick="new_vehicle()">+ Create Vehicle</button>
					</td>
				</tr>
			</table>

		</div>
		<div class="col-sm-6">
			<table class="table table-striped">
				<thead>
					<tr>
						<th scope="col">Track</th>
						<th scope="col">Version</th>
						<th scope="col">Last Edit</th>
						<th scope="col"></th>
					</tr>
				</thead>
				$for track in tracks:
					<tr>
						<td>${track.name}</td>
						<td>${track.version}</td>
						<td>${track.edit_date}</td>
						<td>
							$if track.log:
								<button class="btn-sm btn-warning">Error Log</button>
							$else:
								OK
						</td>
						<!--<th>
							<button class="btn-primary" onclick="edit_track(${track.name}, ${track.version})">Edit</button>
						</th>-->
					</tr>
				<tr>
					<td colspan="5">
						<button id="remove" class="btn btn-secondary btn-block btn-sm" onclick="new_track()">+ Create Track</button>
					</td>
				</tr>
			</table>
		</div>
	</div>

	<table class="table table-striped">
		<thead>
			<tr>
				<th scope="col">Study</th>
				<th scope="col">Version</th>
				<th scope="col">State</th>
				<th scope="col"></th>
			</tr>
		</thead>
		$for study in studies:
			<tr>
				<th>${study.name}</th>
				<th>${study.version}</th>
				$if study.status == 0:
					<th>
						Drafting (Edited ${study.edit_date})
					</th><th>
						<button class="btn btn-sm btn-primary">Edit & Submit</button>
				$elif study.status == 1:
					<th>
						Submitted (${study.submission_date})
					</th><th>
				$elif study.status == 2:
					<th>
						Running (${study.runs_complete}/${study.runs_total})
					</th><th>
						<button class="btn btn-sm btn-info">Log</button>
				$elif study.status == 3:
					<th>
						Failed (${study.completion_date})
					</th><th>
						<button class="btn btn-sm btn-warning">Log</button>
				$elif study.status == 4:
					<th>
						Finished (${study.completion_date})
					</th><th>
						<button class="btn btn-sm btn-info">Log</button>
						<button class="btn btn-sm btn-success">Results</button>
				$else:
					<th>
						Invalid Status
					</th><th>
						
				<button class="btn btn-sm btn-primary" onclick="edit_study(${study.name}, ${study.version})">Edit</button>
				<button class="btn btn-danger btn-sm" onclick="delete_vehicle(${vehicle.name}, ${vehicle.version})">Delete</button>
				</th>
			</tr>
		<tr>
			<td colspan="5">
				<button id="remove" class="btn btn-secondary btn-block btn-sm" onclick="new_study()">+ Create Study</button>
			</td>
		</tr>
	</table>
</div>